@page "/Management/Course"
@using DUPSS.API.Models.DTOs
@using DUPSS.API.Models.Objects
@using DUPSS.Web.Components.Service
@inject NavigationManager NavigationManager
@inject CourseApiService CourseApiService
@inject CourseTopicApiService CourseTopicApiService
@inject RoleApiService RoleApiService
@inject UserApiService UserApiService
@inject IJSRuntime JS
@inject IWebHostEnvironment WebHostEnvironment // Inject IWebHostEnvironment to get wwwroot path

@* We can nest AuthorizeView but make sure to add Context to the innerAuthorizeView *@
@*Example below*@

<div class="course-management-container">
    <div class="header-section">
        <h1 class="page-title">Course Management</h1>

        <div class="actions">
            <button class="add-course-button" @onclick="AddCourse">
                <i class="bi bi-plus-circle"></i> ADD COURSE
            </button>
        </div>
    </div>
    <div class="filter-sort-section">
        <div class="search-input-container">
            <input type="text" class="form-control" placeholder="Search by Course Name, Topic, Staff, Consultant, ID, Description"
                   @bind="searchTerm" @bind:event="oninput" @onkeyup="FilterAndSortCourses"/>
        </div>

        <div class="filter-dropdown-container">
            <select class="form-select" @onchange="OnTopicFilterChanged">
                <option value="">All Topics</option>
                @if (topics != null)
                {
                    @foreach (var topic in topics)
                    {
                        <option value="@topic.TopicId">@topic.TopicName</option>
                    }
                }
            </select>
        </div>

        <div class="filter-dropdown-container">
            <select class="form-select" @onchange="OnStaffFilterChanged">
                <option value="">All Staff</option>
                @if (staffUsers != null)
                {
                    @foreach (var staff in staffUsers)
                    {
                        <option value="@staff.UserId">@staff.Username</option>
                    }
                }
            </select>
        </div>

        <div class="filter-dropdown-container">
            <select class="form-select" @onchange="OnConsultantFilterChanged">
                <option value="">All Consultants</option>
                @if (consultantUsers != null)
                {
                    @foreach (var consultant in consultantUsers)
                    {
                        <option value="@consultant.UserId">@consultant.Username</option>
                    }
                }
            </select>
        </div>

        @* Sort controls *@
        <div class="sort-controls">
            <select class="form-select" @bind="sortBy" @bind:after="FilterAndSortCourses">
                <option value="CourseId">Sort: Course ID</option>
                <option value="CourseName">Sort: Course Name</option>
                <option value="TopicName">Sort: Topic Name</option>
                <option value="StaffName">Sort: Staff Name</option>
                <option value="ConsultantName">Sort: Consultant Name</option>
            </select>
            <button class="btn btn-outline-primary sort-direction-button" @onclick="ToggleSortDirection">
                @if (sortDirection == SortDirection.Ascending)
                {
                    <i class="bi bi-sort-alpha-down"></i>
                }
                else
                {
                    <i class="bi bi-sort-alpha-down-alt"></i>
                }
            </button>
        </div>
    </div>

    @if (courses == null || topics == null || staffUsers == null || roles == null || consultantUsers == null)
    {
        <div class="loading-indicator">Loading courses and related data...</div>
    }
    else if (hasError)
    {
        <div class="error-message">Error loading data. Please try again later.</div>
    }
    else if (!filteredCourses.Any())
    {
        <div class="no-data-message">No courses found matching your criteria.</div>
    }
    else
    {
        <div class="table-container">
            <table class="course-table">
                <thead>
                <tr>
                    <th>No</th>
                    <th>Course ID</th>
                    <th>Course Name</th>
                    <th>Course Type</th>
                    <th>Topic Name</th>
                    <th>Staff Name</th>
                    <th>Consultant Name</th>
                    <th>Description</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>
                @{
                    var index = (currentPage - 1) * itemsPerPage + 1;
                }
                @foreach (var course in PaginatedCourses)
                {
                    <tr>
                        <td>@index</td>
                        <td>@course.CourseId</td>
                        <td>@course.CourseName</td>
                        <td>
                            @if (course.CourseType?.Equals("Online", StringComparison.OrdinalIgnoreCase) == true)
                            {
                                <span class="online-indicator" title="Online Course"></span>
                            }
                            else if (course.CourseType?.Equals("Offline", StringComparison.OrdinalIgnoreCase) == true)
                            {
                                <span class="offline-indicator" title="Offline Course"></span>
                            }
                            else if (course.CourseType?.Equals("Hybrid", StringComparison.OrdinalIgnoreCase) == true)
                            {
                                <span class="hybrid-indicator" title="Hybrid Course"></span>
                            }
                            @course.CourseType
                        </td>
                        <td>@course.Topic?.TopicName</td>
                        <td>@course.Staff?.Username</td>
                        <td>@course.Consultant?.Username</td>
                        <td>@(course.Description?.Length > 100 ? course.Description.Substring(0, 100) + "..." : course.Description)</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary me-2"
                                        @onclick="() => EditCourse(course.CourseId)">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" @onclick="() => DeleteCourse(course.CourseId)">
                                    <i class="bi bi-trash3-fill"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    index++;
                }
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-center mt-3">
            @for (var i = 1; i <= TotalPages; i++)
            {
                var pageIndex = i;
                <button class="btn btn-outline-primary mx-1 @(pageIndex == currentPage ? "active" : "")"
                        @onclick="() => GoToPage(pageIndex)">
                    @pageIndex
                </button>
            }
        </div>
    }

    @if (showEditForm)
    {
        <div class="card p-3 my-4 edit-form-card">
            <h5>@(isNewCourse ? "Add New Course" : "Edit Course: " + courseToEdit.CourseName)</h5>

            @* Validation Message Display *@
            @if (!string.IsNullOrEmpty(validationMessage))
            {
                <div class="alert alert-danger" role="alert">
                    @validationMessage
                </div>
            }

            <div class="mb-3">
                <label class="form-label">Course Name</label>
                <input class="form-control" @bind="courseToEdit.CourseName"/>
            </div>

            <div class="mb-3">
                <label class="form-label">Course Type</label>
                <select class="form-select" @bind="courseToEdit.CourseType">
                    <option value="Online">Online</option>
                    <option value="Hybrid">Hybrid</option>
                    <option value="Offline">Offline</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">Topic</label>
                @* Conditional rendering for Topic input/select *@
                @if (showNewTopicInput)
                {
                    <input type="text" class="form-control" @bind="newTopicName" placeholder="Enter new topic name"/>
                    <button class="btn btn-sm btn-outline-secondary mt-2" @onclick="CancelNewTopicInput">Cancel New
                        Topic
                    </button>
                }
                else
                {
                    <select class="form-select" @bind="courseToEdit.TopicId">
                        <option value="">Select Topic</option>
                        @if (topics != null)
                        {
                            @foreach (var topic in topics)
                            {
                                <option value="@topic.TopicId">@topic.TopicName</option>
                            }
                        }
                    </select>
                    <div class="d-flex justify-content-between mt-2">
                        <button class="btn btn-sm btn-outline-info" @onclick="PromptAddNewTopic">Add New Topic</button>
                        @* Delete Topic button (visible if a topic is selected) *@
                        @if (!string.IsNullOrWhiteSpace(courseToEdit.TopicId))
                        {
                            <button class="btn btn-sm btn-outline-danger"
                                    @onclick="() => DeleteTopic(courseToEdit.TopicId)">Delete Selected Topic
                            </button>
                        }
                    </div>
                }
            </div>

            <div class="mb-3">
                <label class="form-label">Staff</label>
                <select class="form-select" @bind="courseToEdit.StaffId">
                    <option value="">Select Staff</option>
                    @if (staffUsers != null)
                    {
                        @foreach (var staff in staffUsers)
                        {
                            <option value="@staff.UserId">@staff.Username</option>
                        }
                    }
                </select>
            </div>

            @* Description input *@
            <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" @bind="courseToEdit.Description" rows="5" placeholder="Enter detailed course description"></textarea>
            </div>

            @* Consultant dropdown *@
            <div class="mb-3">
                <label class="form-label">Consultant</label>
                <select class="form-select" @bind="courseToEdit.ConsultantId">
                    <option value="">Select Consultant</option>
                    @if (consultantUsers != null)
                    {
                        @foreach (var consultant in consultantUsers)
                        {
                            <option value="@consultant.UserId">@consultant.Username</option>
                        }
                    }
                </select>
            </div>

            @* Image Upload Section *@
            <div class="mb-3">
                <label class="form-label">Course Image</label>
                <InputFile OnChange="HandleFileSelection" accept=".jpg,.jpeg,.png" />
                @if (!string.IsNullOrEmpty(courseToEdit.ImageUrl))
                {
                    <div class="mt-2">
                        <p>Current Image:</p>
                        <img src="@courseToEdit.ImageUrl" alt="Current Course Image" class="img-thumbnail" style="max-width: 200px; max-height: 200px; border-radius: 8px;" />
                    </div>
                }
                else if (selectedFile != null)
                {
                    <div class="mt-2">
                        <p>File selected for upload: @selectedFile.Name</p>
                    </div>
                }
                else
                {
                    <div class="mt-2 text-muted">No image selected.</div>
                }
            </div>

            <div>
                <button class="btn btn-success me-2" @onclick="SaveCourse">Save</button>
                <button class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
            </div>
        </div>
    }
</div>

@code {
    private List<CourseDTO>? courses;
    private List<CourseTopic>? topics;
    private List<UserDTO>? staffUsers;
    private List<UserDTO>? consultantUsers;
    private List<RoleDTO>? roles;
    private bool hasError = false;
    private int currentPage = 1;
    private int itemsPerPage = 8;
    private string validationMessage = string.Empty;

    // Search, Sort, Filter state
    private string searchTerm = string.Empty;
    private string selectedTopicId = string.Empty;
    private string selectedStaffId = string.Empty;
    private string selectedConsultantId = string.Empty;
    private string sortBy = "CourseId"; // Default sort column is CourseId
    private SortDirection sortDirection = SortDirection.Ascending; // Default sort direction

    private enum SortDirection { Ascending, Descending }

    // For Add/Edit Form
    private CourseDTO courseToEdit = new CourseDTO
    {
        CourseId = "",
        CourseName = "",
        CourseType = "Online", // Default to online
        TopicId = "",
        StaffId = "",
        Description = "", // Initialize description
        ConsultantId = "" // Initialize consultant ID
    };
    private bool showEditForm = false;
    private bool isNewCourse = false;
    private bool showNewTopicInput = false; // Controls visibility of new topic input
    private string newTopicName = string.Empty; // Binds to the new topic input field
    private IBrowserFile? selectedFile; // Holds the file selected by InputFile

    // Define a maximum file size for uploads in this component (e.g., 5 MB)
    // This value will be used directly when opening the file stream.
    private const long MaxAllowedFileSize = 5 * 1024 * 1024; // 5 MB

    private List<CourseDTO> filteredCourses = new List<CourseDTO>();

    private IEnumerable<CourseDTO> PaginatedCourses =>
        filteredCourses?
            .Skip((currentPage - 1) * itemsPerPage)
            .Take(itemsPerPage) ?? Enumerable.Empty<CourseDTO>();

    private int TotalPages => (int)Math.Ceiling((filteredCourses?.Count ?? 0) / (double)itemsPerPage);

    private void GoToPage(int page)
    {
        if (page < 1) page = 1;
        if (page > TotalPages) page = TotalPages;

        if (currentPage != page)
        {
            currentPage = page;
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            courses = await CourseApiService.GetAllAsync();
            topics = await CourseTopicApiService.GetAllAsync();
            roles = await RoleApiService.GetAllAsync();
            var allUsers = await UserApiService.GetAllAsync();

            // Filter for Staff users (assuming RoleId starts with "ST")
            var staffRoleIds = roles?.Where(r => r.RoleId.StartsWith("ST", StringComparison.OrdinalIgnoreCase)).Select(r => r.RoleId).ToList();
            staffUsers = allUsers?.Where(u => staffRoleIds != null && staffRoleIds.Contains(u.RoleId)).ToList();

            // Filter for Consultant users (assuming RoleId starts with "CS" or "CO" from database)
            var consultantRoleIds = roles?.Where(r => r.RoleId.StartsWith("CS", StringComparison.OrdinalIgnoreCase) || r.RoleId.StartsWith("CO", StringComparison.OrdinalIgnoreCase)).Select(r => r.RoleId).ToList();
            consultantUsers = allUsers?.Where(u => consultantRoleIds != null && consultantRoleIds.Contains(u.RoleId)).ToList();

            FilterAndSortCourses(); // Apply initial filter and sort
            hasError = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching data: {ex.Message}");
            courses = new List<CourseDTO>();
            filteredCourses = new List<CourseDTO>();
            topics = new List<CourseTopic>();
            staffUsers = new List<UserDTO>();
            consultantUsers = new List<UserDTO>();
            roles = new List<RoleDTO>();
            hasError = true;
        }
    }

    // Central method to apply all search, filter, and sort logic
    private void FilterAndSortCourses()
    {
        if (courses == null)
        {
            filteredCourses = new List<CourseDTO>();
            return;
        }

        IEnumerable<CourseDTO> query = courses;

        // Apply Search Term (Course Name, Topic Name, Staff Name, Consultant Name, Course ID, Description)
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var lowerSearchTerm = searchTerm.ToLower();
            query = query.Where(c =>
                (c.CourseName?.ToLower().Contains(lowerSearchTerm) ?? false) ||
                (c.Topic?.TopicName?.ToLower().Contains(lowerSearchTerm) ?? false) ||
                (c.Staff?.Username?.ToLower().Contains(lowerSearchTerm) ?? false) ||
                (c.Consultant?.Username?.ToLower().Contains(lowerSearchTerm) ?? false) ||
                (c.CourseId?.ToLower().Contains(lowerSearchTerm) ?? false) ||
                (c.Description?.ToLower().Contains(lowerSearchTerm) ?? false)
            );
        }

        // Apply Topic Filter
        if (!string.IsNullOrWhiteSpace(selectedTopicId))
        {
            query = query.Where(c => c.TopicId == selectedTopicId);
        }

        // Apply Staff Filter
        if (!string.IsNullOrWhiteSpace(selectedStaffId))
        {
            query = query.Where(c => c.StaffId == selectedStaffId);
        }

        // Apply Consultant Filter
        if (!string.IsNullOrWhiteSpace(selectedConsultantId))
        {
            query = query.Where(c => c.ConsultantId == selectedConsultantId);
        }

        // Apply Sorting
        switch (sortBy)
        {
            case "CourseName":
                query = sortDirection == SortDirection.Ascending ?
                    query.OrderBy(c => c.CourseName, StringComparer.OrdinalIgnoreCase) :
                    query.OrderByDescending(c => c.CourseName, StringComparer.OrdinalIgnoreCase);
                break;
            case "TopicName":
                query = sortDirection == SortDirection.Ascending ?
                    query.OrderBy(c => c.Topic?.TopicName, StringComparer.OrdinalIgnoreCase) :
                    query.OrderByDescending(c => c.Topic?.TopicName, StringComparer.OrdinalIgnoreCase);
                break;
            case "StaffName":
                query = sortDirection == SortDirection.Ascending ?
                    query.OrderBy(c => c.Staff?.Username, StringComparer.OrdinalIgnoreCase) :
                    query.OrderByDescending(c => c.Staff?.Username, StringComparer.OrdinalIgnoreCase);
                break;
            case "ConsultantName":
                query = sortDirection == SortDirection.Ascending ?
                    query.OrderBy(c => c.Consultant?.Username, StringComparer.OrdinalIgnoreCase) :
                    query.OrderByDescending(c => c.Consultant?.Username, StringComparer.OrdinalIgnoreCase);
                break;
            case "CourseId":
                query = sortDirection == SortDirection.Ascending ?
                    query.OrderBy(c => c.CourseId) :
                    query.OrderByDescending(c => c.CourseId);
                break;
            default:
                query = query.OrderBy(c => c.CourseId);
                break;
        }

        filteredCourses = query.ToList();
        currentPage = 1; // Reset to first page after filtering/sorting
    }

    private void OnTopicFilterChanged(ChangeEventArgs e)
    {
        selectedTopicId = e.Value?.ToString() ?? string.Empty;
        FilterAndSortCourses();
    }

    private void OnStaffFilterChanged(ChangeEventArgs e)
    {
        selectedStaffId = e.Value?.ToString() ?? string.Empty;
        FilterAndSortCourses();
    }

    private void OnConsultantFilterChanged(ChangeEventArgs e)
    {
        selectedConsultantId = e.Value?.ToString() ?? string.Empty;
        FilterAndSortCourses();
    }

    private void ToggleSortDirection()
    {
        sortDirection = sortDirection == SortDirection.Ascending ? SortDirection.Descending : SortDirection.Ascending;
        FilterAndSortCourses(); // Re-apply filter and sort with new direction
    }

    // Helper method to generate the next sequential CourseId
    private string GenerateNextCourseId()
    {
        var maxIdNum = 0;
        if (courses != null && courses.Any())
        {
            maxIdNum = courses
                .Select(c => {
                    if (c.CourseId != null && c.CourseId.StartsWith("C") && int.TryParse(c.CourseId.Substring(1), out var num))
                    {
                        return num;
                    }
                    return 0;
                })
                .DefaultIfEmpty(0)
                .Max();
        }
        return $"C{maxIdNum + 1:D4}";
    }

    // Helper method to generate the next sequential TopicId (TP0000 format)
    private string GenerateNextTopicId()
    {
        var maxIdNum = 0;
        if (topics != null && topics.Any())
        {
            maxIdNum = topics
                .Select(t => {
                    if (t.TopicId != null && t.TopicId.StartsWith("TP") && int.TryParse(t.TopicId.Substring(2), out var num))
                    {
                        return num;
                    }
                    return 0;
                })
                .DefaultIfEmpty(0)
                .Max();
        }
        return $"TP{maxIdNum + 1:D4}";
    }

    // Handles the file selection from the InputFile component
    private void HandleFileSelection(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        validationMessage = string.Empty; // Clear validation message on new file selection
        if (selectedFile != null)
        {
            Console.WriteLine($"File selected: {selectedFile.Name}, Size: {selectedFile.Size} bytes, ContentType: {selectedFile.ContentType}");
        }
    }

    private void AddCourse()
    {
        validationMessage = string.Empty;
        showNewTopicInput = false;
        newTopicName = string.Empty;
        courseToEdit = new CourseDTO
        {
            CourseId = GenerateNextCourseId(),
            CourseName = "",
            CourseType = "Online",
            TopicId = "",
            StaffId = "",
            Description = "",
            ConsultantId = "",
            ImageUrl = null // Ensure ImageUrl is reset for new course
        };
        isNewCourse = true;
        showEditForm = true;
        selectedFile = null; // Clear any previously selected file
    }

    private void EditCourse(string courseId)
    {
        validationMessage = string.Empty;
        showNewTopicInput = false;
        newTopicName = string.Empty;
        var course = courses?.FirstOrDefault(c => c.CourseId == courseId);
        if (course != null)
        {
            courseToEdit = new CourseDTO
            {
                CourseId = course.CourseId,
                CourseName = course.CourseName,
                CourseType = course.CourseType,
                TopicId = course.TopicId,
                StaffId = course.StaffId,
                Description = course.Description,
                ConsultantId = course.ConsultantId,
                Topic = course.Topic,
                Staff = course.Staff,
                Consultant = course.Consultant,
                ImageUrl = course.ImageUrl // Retain the existing ImageUrl for display
            };
            isNewCourse = false;
            showEditForm = true;
            selectedFile = null; // Clear any previously selected file
        }
    }

    private void PromptAddNewTopic()
    {
        showNewTopicInput = true;
        courseToEdit.TopicId = "";
        newTopicName = string.Empty;
        validationMessage = string.Empty;
    }

    private void CancelNewTopicInput()
    {
        showNewTopicInput = false;
        newTopicName = string.Empty;
        validationMessage = string.Empty;
    }

    private async Task DeleteTopic(string topicIdToDelete)
    {
        if (string.IsNullOrWhiteSpace(topicIdToDelete))
        {
            validationMessage = "No topic selected for deletion.";
            return;
        }

        var topic = topics?.FirstOrDefault(t => t.TopicId == topicIdToDelete);
        if (topic == null)
        {
            validationMessage = "Topic not found.";
            return;
        }

        var coursesUsingTopic = courses?.Any(c => c.TopicId == topicIdToDelete) ?? false;
        if (coursesUsingTopic)
        {
            validationMessage = $"Cannot delete topic '{topic.TopicName}' because it is currently assigned to one or more courses. Please reassign courses first.";
            return;
        }

        var confirmed = await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to delete topic '{topic.TopicName}' (ID: {topicIdToDelete})?");
        if (confirmed)
        {
            try
            {
                var success = await CourseTopicApiService.DeleteAsync(topicIdToDelete);
                if (success)
                {
                    Console.WriteLine($"Topic '{topic.TopicName}' (ID: {topicIdToDelete}) deleted successfully.");
                    validationMessage = string.Empty;

                    topics = await CourseTopicApiService.GetAllAsync();
                    courses = await CourseApiService.GetAllAsync();
                    FilterAndSortCourses();

                    if (courseToEdit.TopicId == topicIdToDelete)
                    {
                        courseToEdit.TopicId = "";
                    }
                }
                else
                {
                    validationMessage = $"Failed to delete topic '{topic.TopicName}'.";
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting topic: {ex.Message}");
                validationMessage = $"Error deleting topic: {ex.Message}";
            }
        }
    }

    private async Task SaveCourse()
    {
        // --- Client-side Validation ---
        if (string.IsNullOrWhiteSpace(courseToEdit.CourseName))
        {
            validationMessage = "Course Name cannot be empty.";
            return;
        }
        if (showNewTopicInput)
        {
            if (string.IsNullOrWhiteSpace(newTopicName))
            {
                validationMessage = "New Topic Name cannot be empty.";
                return;
            }
            var existingTopic = topics?.FirstOrDefault(t => t.TopicName.Equals(newTopicName, StringComparison.OrdinalIgnoreCase));
            if (existingTopic != null)
            {
                validationMessage = $"Topic '{newTopicName}' already exists. Please select it from the dropdown or enter a different name.";
                return;
            }
        }
        else
        {
            if (string.IsNullOrWhiteSpace(courseToEdit.TopicId))
            {
                validationMessage = "Please select a Topic.";
                return;
            }
        }

        if (string.IsNullOrWhiteSpace(courseToEdit.StaffId))
        {
            validationMessage = "Please select a Staff.";
            return;
        }

        if (string.IsNullOrWhiteSpace(courseToEdit.Description))
        {
            validationMessage = "Description cannot be empty.";
            return;
        }

        if (string.IsNullOrWhiteSpace(courseToEdit.ConsultantId))
        {
            validationMessage = "Please select a Consultant.";
            return;
        }
        // --- End Client-side Validation ---

        validationMessage = string.Empty; // Clear any previous validation messages if all checks pass

        try
        {
            // --- Handle New Topic Creation if applicable ---
            if (showNewTopicInput && !string.IsNullOrWhiteSpace(newTopicName))
            {
                var newTopicId = GenerateNextTopicId();
                var newTopic = new CourseTopic { TopicId = newTopicId, TopicName = newTopicName };
                await CourseTopicApiService.CreateAsync(newTopic);
                courseToEdit.TopicId = newTopic.TopicId; // Assign the newly created topic's ID
                topics = await CourseTopicApiService.GetAllAsync(); // Refresh topics list
                showNewTopicInput = false;
                newTopicName = string.Empty;
            }

            // --- Handle Image Upload ---
            if (selectedFile != null)
            {
                Console.WriteLine($"File selected: {selectedFile.Name}, Size: {selectedFile.Size} bytes, ContentType: {selectedFile.ContentType}");
                Console.WriteLine($"Attempting to save image for Course ID: {courseToEdit.CourseId}");
                Console.WriteLine($"Original file name: {selectedFile.Name}, Size: {selectedFile.Size} bytes, ContentType: {selectedFile.ContentType}");

                var fileExtension = Path.GetExtension(selectedFile.Name).ToLowerInvariant();
                // Basic validation for image file types
                if (fileExtension != ".jpg" && fileExtension != ".jpeg" && fileExtension != ".png")
                {
                    validationMessage = "Only JPG, JPEG, or PNG images are allowed for Course Image.";
                    Console.WriteLine($"Validation failed: Invalid file type '{fileExtension}'.");
                    return; // Stop saving if file type is invalid
                }

                // Check file size against MaxAllowedFileSize constant
                if (selectedFile.Size > MaxAllowedFileSize)
                {
                    validationMessage = $"File size exceeds the maximum allowed size of {MaxAllowedFileSize / (1024 * 1024)} MB.";
                    Console.WriteLine($"Validation failed: File size ({selectedFile.Size} bytes) exceeds MaxAllowedFileSize ({MaxAllowedFileSize} bytes).");
                    return; // Stop saving if file is too large
                }

                // Construct the new file name (CourseId.extension)
                var newFileName = $"{courseToEdit.CourseId}{fileExtension}";
                // Construct the full path to save in wwwroot/images
                var imagePath = Path.Combine(WebHostEnvironment.WebRootPath, "images", newFileName);
                Console.WriteLine($"Target path for saving: {imagePath}");

                try
                {
                    // Use CopyToAsync for more robust stream copying
                    long bytesCopied = 0;
                    // Removed TimeSpan.FromSeconds(60) argument
                    using (var inputStream = selectedFile.OpenReadStream(MaxAllowedFileSize, CancellationToken.None))
                    {
                        Console.WriteLine($"Input stream opened from browser. Length: {inputStream.Length}");
                        Console.WriteLine($"Input Stream Position before CopyToAsync: {inputStream.Position}"); // Log position

                        using (FileStream outputStream = new FileStream(imagePath, FileMode.Create, FileAccess.Write, FileShare.ReadWrite))
                        {
                            Console.WriteLine("Output FileStream created successfully.");
                            Console.WriteLine("Attempting to copy data from input stream to output file stream...");
                            await inputStream.CopyToAsync(outputStream);
                            Console.WriteLine("Finished CopyToAsync. Flushing output stream.");
                            await outputStream.FlushAsync(); // Ensure data is written to disk
                            bytesCopied = outputStream.Length; // Get actual bytes written from the output stream
                        }
                        Console.WriteLine("Output FileStream disposed.");
                    }
                    Console.WriteLine("Input stream disposed.");


                    // IMPORTANT: Verify that the number of bytes copied matches the expected file size.
                    // Compare bytesCopied with selectedFile.Size (original size from browser)
                    if (bytesCopied != selectedFile.Size)
                    {
                        Console.WriteLine($"WARNING: Bytes copied ({bytesCopied}) does not match original file size ({selectedFile.Size}). File might be incomplete/corrupted.");
                        validationMessage = "File was partially saved. Please try uploading again.";
                        if (File.Exists(imagePath))
                        {
                            File.Delete(imagePath);
                            Console.WriteLine($"Deleted incomplete file: {imagePath}");
                        }
                        return; // Stop further processing if file is corrupted
                    }


                    Console.WriteLine($"Image saved successfully to {imagePath}. Total bytes copied: {bytesCopied}");
                    courseToEdit.ImageUrl = $"/images/{newFileName}"; // Update the DTO with the new image URL
                    selectedFile = null; // Clear selected file after successful upload
                }
                catch (UnauthorizedAccessException uaEx)
                {
                    Console.Error.WriteLine($"ERROR: Unauthorized access when creating/writing FileStream. Check folder permissions for '{imagePath}'. Error: {uaEx.Message}");
                    validationMessage = $"Permission denied: Cannot write to '{Path.GetFileName(imagePath)}'. Please check folder permissions (Modify/Full Control) for the 'images' folder.";
                    // Attempt to delete potentially corrupted file
                    if (File.Exists(imagePath)) { File.Delete(imagePath); }
                    return; // Exit immediately
                }
                catch (IOException ioEx)
                {
                    Console.Error.WriteLine($"ERROR: IO Error during file operation. Error: {ioEx.Message}");
                    validationMessage = $"A file system error occurred: {ioEx.Message}. Check if the file is locked or disk space.";
                    // Attempt to delete potentially corrupted file
                    if (File.Exists(imagePath)) { File.Delete(imagePath); }
                    return; // Exit immediately
                }
                catch (Exception finalEx) // General catch for any errors during read/write/validation
                {
                    Console.Error.WriteLine($"ERROR: Unexpected error during image save process: {finalEx.Message}");
                    Console.Error.WriteLine($"Stack Trace: {finalEx.StackTrace}");
                    validationMessage = $"An unexpected error occurred during image saving: {finalEx.Message}";
                    // Attempt to delete potentially corrupted file
                    if (File.Exists(imagePath))
                    {
                        File.Delete(imagePath);
                        Console.WriteLine($"Deleted problematic file due to general error: {imagePath}");
                    }
                    return;
                }
            }


            // --- Perform Create or Update ---
            CourseDTO? savedCourse;
            if (isNewCourse)
            {
                savedCourse = await CourseApiService.CreateAsync(courseToEdit);
            }
            else
            {
                savedCourse = await CourseApiService.UpdateAsync(courseToEdit);
            }

            if (savedCourse != null)
            {
                Console.WriteLine("Course saved successfully, refreshing data.");
                // Refresh all data
                courses = await CourseApiService.GetAllAsync();
                FilterAndSortCourses();
                CancelEdit(); // Close the form
            }
            else
            {
                Console.WriteLine("Course save failed (API returned null).");
                validationMessage = "Failed to save course. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"ERROR: Error during course save operation (outer catch): {ex.Message}");
            Console.Error.WriteLine($"Stack Trace: {ex.StackTrace}");
            validationMessage = $"An unexpected critical error occurred: {ex.Message}";
            // In case of any error, ensure the selected file is cleared
            selectedFile = null;
        }
    }

    private void CancelEdit()
    {
        showEditForm = false;
        isNewCourse = false;
        validationMessage = string.Empty;
        selectedFile = null; // Clear selected file when canceling
        showNewTopicInput = false;
        newTopicName = string.Empty;
    }

    private async Task DeleteCourse(string courseId)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to delete course with ID: {courseId}?");
        if (confirmed)
        {
            try
            {
                var success = await CourseApiService.DeleteAsync(courseId);
                if (success)
                {
                    Console.WriteLine($"Course with ID {courseId} deleted successfully.");
                    // Refresh the list of courses
                    courses = await CourseApiService.GetAllAsync();
                    FilterAndSortCourses(); // Re-apply filters and sort after deletion
                }
                else
                {
                    Console.WriteLine($"Failed to delete course with ID {courseId}.");
                    validationMessage = $"Failed to delete course with ID {courseId}. Course might not exist or an error occurred.";
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting course: {ex.Message}");
                validationMessage = $"Error deleting course: {ex.Message}";
            }
        }
    }
}
