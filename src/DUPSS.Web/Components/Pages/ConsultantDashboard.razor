@page "/ConsultantDashboard"
@using DUPSS.API.Models.DTOs
@using DUPSS.Web.Components.Service
@inject AppointmentApiService AppointmentApiService
@inject AuthenticationStateProvider AuthProvider

<h3 class="mb-4">🎯 Consultant Dashboard</h3>

@if (isLoading)
{
    <p>Loading data...</p>
}
else
{
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">Today</h5>
                    <p class="card-text fs-4">@todayCount</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title">Upcoming</h5>
                    <p class="card-text fs-4">@upcomingCount</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-secondary mb-3">
                <div class="card-body">
                    <h5 class="card-title">Finished</h5>
                    <p class="card-text fs-4">@finishedCount</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger mb-3">
                <div class="card-body">
                    <h5 class="card-title">Canceled</h5>
                    <p class="card-text fs-4">@canceledCount</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-white bg-danger mb-3">
                <div class="card-body">
                    <h5 class="card-title">Declined</h5>
                    <p class="card-text fs-4">@declinedCount</p>
                </div>
            </div>
        </div>
    </div>

    <h4>📅 Upcoming Appointments</h4>
    @if (!upcomingAppointments.Any())
    {
        <p>No upcoming appointments.</p>
    }
    else
    {
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Member</th>
                    <th>Topic</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var appt in upcomingAppointments)
                {
                    <tr>
                        <td>@appt.AppointmentDate.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@appt.Member?.Username</td>
                        <td>@appt.Topic</td>
                        <td>@appt.Status</td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <NavLink class="btn btn-outline-primary mt-3" href="/AppointmentForConsultant">View All Appointments</NavLink>
}

@code {
    private bool isLoading = true;
    private List<AppointmentDTO> allAppointments = new();
    private List<AppointmentDTO> upcomingAppointments = new();

    private int todayCount;
    private int upcomingCount;
    private int finishedCount;
    private int canceledCount;
    private int declinedCount;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var userId = authState.User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(userId))
        {
            allAppointments = await AppointmentApiService.GetAppointmentsForConsultantAsync(userId);
            todayCount = allAppointments.Count(a => a.AppointmentDate.Date == DateTime.Today);
            upcomingAppointments = allAppointments
                .Where(a => a.AppointmentDate > DateTime.Now && (a.Status == "Accepted" || a.Status == "Pending"))
                .OrderBy(a => a.AppointmentDate)
                .Take(5)
                .ToList();
            upcomingCount = upcomingAppointments.Count;
            finishedCount = allAppointments.Count(a => a.Status == "Finished");
            canceledCount = allAppointments.Count(a => a.Status == "Cancel");
            declinedCount = allAppointments.Count(a => a.Status == "Declined");
        }

        isLoading = false;
    }
}
