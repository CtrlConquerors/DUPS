@page "/CourseManagement"
@inject DUPSS.AccessLayer.Interfaces.ICourseDAO CourseDAO
@inject DUPSS.AccessLayer.Interfaces.ICourseTopicDAO CourseTopicDAO
@inject DUPSS.AccessLayer.Interfaces.IUserDAO UserDAO
@inject DUPSS.AccessLayer.Interfaces.IRoleDAO RoleDAO
@inject NavigationManager NavigationManager
@inject IJSRuntime JS // Used for the confirm dialog, but a custom modal is recommended.

<AuthorizeView Roles="AD,MA">
    <Authorized>
        <div class="course-management-container">
            <div class="header-section">
                <h1 class="page-title">Course Management</h1>
                <div class="actions">
                    <button class="add-course-button" @onclick="AddCourse">
                        <i class="bi bi-plus-circle"></i> ADD COURSE
                    </button>
                </div>
            </div>

            <div class="filter-sort-section">
                <div class="search-input-container">
                    <input type="text" class="form-control" placeholder="Search by Course, Topic, Staff, ID"
                           @bind="searchTerm" @bind:event="oninput" @onkeyup="FilterAndSortCourses" />
                </div>

                <div class="filter-dropdown-container">
                    <select class="form-select" @onchange="OnTopicFilterChanged">
                        <option value="">All Topics</option>
                        @if (topics != null)
                        {
                            @foreach (var topic in topics)
                            {
                                <option value="@topic.TopicId">@topic.TopicName</option>
                            }
                        }
                    </select>
                </div>

                <div class="filter-dropdown-container">
                    <select class="form-select" @onchange="OnStaffFilterChanged">
                        <option value="">All Staff</option>
                        @if (staffUsers != null)
                        {
                            @foreach (var staff in staffUsers)
                            {
                                <option value="@staff.UserId">@staff.Username</option>
                            }
                        }
                    </select>
                </div>

                @* NEW: Sort controls *@
                <div class="sort-controls">
                    <select class="form-select" @bind="sortBy" @bind:after="FilterAndSortCourses">
                        <option value="CourseId">Sort by Course ID</option> @* Changed default sort option *@
                        <option value="CourseName">Sort by Course Name</option>
                        <option value="TopicName">Sort by Topic Name</option>
                        <option value="StaffName">Sort by Staff Name</option>
                    </select>
                    <button class="btn btn-outline-primary sort-direction-button" @onclick="ToggleSortDirection">
                        @if (sortDirection == SortDirection.Ascending)
                        {
                            <i class="bi bi-sort-alpha-down"></i>
                        }
                        else
                        {
                            <i class="bi bi-sort-alpha-down-alt"></i>
                        }
                    </button>
                </div>
            </div>

            @if (courses == null || topics == null || staffUsers == null || roles == null)
            {
                <div class="loading-indicator">Loading courses and related data...</div>
            }
            else if (hasError)
            {
                <div class="error-message">Error loading data. Please try again later.</div>
            }
            else if (!filteredCourses.Any())
            {
                <div class="no-data-message">No courses found matching your criteria.</div>
            }
            else
            {
                <div class="table-container">
                    <table class="course-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Course ID</th>
                                <th>Course Name</th>
                                <th>Course Type</th>
                                <th>Topic Name</th>
                                <th>Staff Name</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int index = (currentPage - 1) * itemsPerPage + 1;
                            }
                            @foreach (var course in PaginatedCourses)
                            {
                                <tr>
                                    <td>@index</td>
                                    <td>@course.CourseId</td>
                                    <td>@course.CourseName</td>
                                    <td>
                                        @if (course.CourseType?.Equals("Online", StringComparison.OrdinalIgnoreCase) == true)
                                        {
                                            <span class="online-indicator" title="Online Course"></span>
                                        }
                                        @course.CourseType
                                    </td>
                                    <td>@course.Topic?.TopicName</td>
                                    <td>@course.Staff?.Username</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-sm btn-primary me-2" @onclick="() => EditCourse(course.CourseId)">
                                                <i class="bi bi-three-dots-vertical"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteCourse(course.CourseId)">
                                                <i class="bi bi-trash3-fill"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                index++;
                            }
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-center mt-3">
                    @for (int i = 1; i <= TotalPages; i++)
                    {
                        var pageIndex = i;
                        <button class="btn btn-outline-primary mx-1 @(pageIndex == currentPage ? "active" : "")"
                                @onclick="() => GoToPage(pageIndex)">
                            @pageIndex
                        </button>
                    }
                </div>
            }

            @if (showEditForm)
            {
                <div class="card p-3 my-4 edit-form-card">
                    <h5>@(isNewCourse ? "Add New Course" : "Edit Course: " + courseToEdit.CourseName)</h5>

                    <div class="mb-3">
                        <label class="form-label">Course Name</label>
                        <input class="form-control" @bind="courseToEdit.CourseName" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Course Type</label>
                        <select class="form-select" @bind="courseToEdit.CourseType">
                            <option value="">Select Type</option>
                            <option value="Online">Online</option>
                            <option value="Hybrid">Hybrid</option>
                            <option value="Offline">Offline</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Topic</label>
                        <select class="form-select" @bind="courseToEdit.TopicId">
                            <option value="">Select Topic</option>
                            @if (topics != null)
                            {
                                @foreach (var topic in topics)
                                {
                                    <option value="@topic.TopicId">@topic.TopicName</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Staff</label>
                        <select class="form-select" @bind="courseToEdit.StaffId">
                            <option value="">Select Staff</option>
                            @if (staffUsers != null)
                            {
                                @foreach (var staff in staffUsers)
                                {
                                    <option value="@staff.UserId">@staff.Username</option>
                                }
                            }
                        </select>
                    </div>

                    <div>
                        <button class="btn btn-success me-2" @onclick="SaveCourse">Save</button>
                        <button class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                    </div>
                </div>
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <p>You are not authorized to access this page.</p>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<DUPSS.Object.Course>? courses;
    private List<DUPSS.Object.Course>? filteredCourses;
    private List<DUPSS.Object.CourseTopic>? topics;
    private List<DUPSS.Object.User>? staffUsers; // To hold users with 'Staff' role
    private List<DUPSS.Object.Role>? roles;
    private bool hasError = false;
    private int currentPage = 1;
    private int itemsPerPage = 8;

    // Search, Sort, Filter state
    private string searchTerm = string.Empty;
    private string selectedTopicId = string.Empty;
    private string selectedStaffId = string.Empty;
    private string sortBy = "CourseId"; // FIXED: Default sort column is now CourseId
    private SortDirection sortDirection = SortDirection.Ascending; // Default sort direction

    private enum SortDirection { Ascending, Descending }

    // For Add/Edit Form
    private DUPSS.Object.Course courseToEdit = new()
    {
        CourseId = "",
        CourseName = "",
        CourseType = "",
        TopicId = "",
        StaffId = ""
    };
    private bool showEditForm = false;
    private bool isNewCourse = false;

    private IEnumerable<DUPSS.Object.Course> PaginatedCourses =>
        filteredCourses?
            .Skip((currentPage - 1) * itemsPerPage)
            .Take(itemsPerPage) ?? Enumerable.Empty<DUPSS.Object.Course>();

    private int TotalPages => (int)Math.Ceiling((filteredCourses?.Count ?? 0) / (double)itemsPerPage);

    private void GoToPage(int page)
    {
        if (page < 1) page = 1;
        if (page > TotalPages) page = TotalPages;

        if (currentPage != page)
        {
            currentPage = page;
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            courses = await CourseDAO.GetAllAsync();
            topics = await CourseTopicDAO.GetAllAsync();
            roles = await RoleDAO.GetAllAsync();
            var allUsers = await UserDAO.GetAllAsync();

            var staffRoleIds = roles?.Where(r => r.RoleId.StartsWith("ST")).Select(r => r.RoleId).ToList();
            staffUsers = allUsers?.Where(u => staffRoleIds != null && staffRoleIds.Contains(u.RoleId)).ToList();

            FilterAndSortCourses(); // Apply initial filter and sort
            hasError = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching data: {ex.Message}");
            courses = new List<DUPSS.Object.Course>();
            filteredCourses = new List<DUPSS.Object.Course>();
            topics = new List<DUPSS.Object.CourseTopic>();
            staffUsers = new List<DUPSS.Object.User>();
            roles = new List<DUPSS.Object.Role>();
            hasError = true;
        }
    }

    // Central method to apply all search, filter, and sort logic
    private void FilterAndSortCourses()
    {
        if (courses == null) return;

        IEnumerable<DUPSS.Object.Course> query = courses;

        // Apply Search Term (Course Name, Topic Name, Staff Name, Course ID)
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            string lowerSearchTerm = searchTerm.ToLower();
            query = query.Where(c =>
                (c.CourseName?.ToLower().Contains(lowerSearchTerm) ?? false) ||
                (c.Topic?.TopicName?.ToLower().Contains(lowerSearchTerm) ?? false) ||
                (c.Staff?.Username?.ToLower().Contains(lowerSearchTerm) ?? false) ||
                (c.CourseId?.ToLower().Contains(lowerSearchTerm) ?? false)
            );
        }

        // Apply Topic Filter
        if (!string.IsNullOrWhiteSpace(selectedTopicId))
        {
            query = query.Where(c => c.TopicId == selectedTopicId);
        }

        // Apply Staff Filter
        if (!string.IsNullOrWhiteSpace(selectedStaffId))
        {
            query = query.Where(c => c.StaffId == selectedStaffId);
        }

        // Apply Sorting
        switch (sortBy)
        {
            case "CourseName":
                query = sortDirection == SortDirection.Ascending ?
                        query.OrderBy(c => c.CourseName, StringComparer.OrdinalIgnoreCase) :
                        query.OrderByDescending(c => c.CourseName, StringComparer.OrdinalIgnoreCase);
                break;
            case "TopicName":
                query = sortDirection == SortDirection.Ascending ?
                        query.OrderBy(c => c.Topic?.TopicName, StringComparer.OrdinalIgnoreCase) :
                        query.OrderByDescending(c => c.Topic?.TopicName, StringComparer.OrdinalIgnoreCase);
                break;
            case "StaffName":
                query = sortDirection == SortDirection.Ascending ?
                        query.OrderBy(c => c.Staff?.Username, StringComparer.OrdinalIgnoreCase) :
                        query.OrderByDescending(c => c.Staff?.Username, StringComparer.OrdinalIgnoreCase);
                break;
            case "CourseId": // Sorting by CourseId
                query = sortDirection == SortDirection.Ascending ?
                        query.OrderBy(c => c.CourseId) :
                        query.OrderByDescending(c => c.CourseId);
                break;
            default:
                query = query.OrderBy(c => c.CourseId);
                break;
        }

        filteredCourses = query.ToList();
        currentPage = 1; // Reset to first page after filtering/sorting
    }

    private void OnTopicFilterChanged(ChangeEventArgs e)
    {
        selectedTopicId = e.Value?.ToString() ?? string.Empty;
        FilterAndSortCourses();
    }

    private void OnStaffFilterChanged(ChangeEventArgs e)
    {
        selectedStaffId = e.Value?.ToString() ?? string.Empty;
        FilterAndSortCourses();
    }

    private void ToggleSortDirection()
    {
        sortDirection = (sortDirection == SortDirection.Ascending) ? SortDirection.Descending : SortDirection.Ascending;
        FilterAndSortCourses(); // Re-apply filter and sort with new direction
    }

    // Helper method to generate the next sequential CourseId
    private string GenerateNextCourseId()
    {
        int maxIdNum = 0;
        if (courses != null && courses.Any())
        {
            // Find the maximum numeric part from existing CourseIds
            maxIdNum = courses
                .Select(c =>
                {
                    if (c.CourseId != null && c.CourseId.StartsWith("C") && int.TryParse(c.CourseId.Substring(1), out int num))
                    {
                        return num;
                    }
                    return 0; // Return 0 for invalid IDs
                })
                .DefaultIfEmpty(0) // Handle case where there are no valid "C" IDs
                .Max();
        }

        // Increment and format
        return $"C{(maxIdNum + 1):D4}"; // D4 formats to 4 digits, e.g., 1 -> 0001
    }

    private void AddCourse()
    {
        courseToEdit = new DUPSS.Object.Course
        {
            CourseId = GenerateNextCourseId(),
            CourseName = "",
            CourseType = "Online",
            TopicId = "",
            StaffId = ""
        };
        isNewCourse = true;
        showEditForm = true;
    }

    private void EditCourse(string courseId)
    {
        var course = courses?.FirstOrDefault(c => c.CourseId == courseId);
        if (course != null)
        {
            courseToEdit = new DUPSS.Object.Course
            {
                CourseId = course.CourseId,
                CourseName = course.CourseName,
                CourseType = course.CourseType,
                TopicId = course.TopicId,
                StaffId = course.StaffId,
                Topic = course.Topic,
                Staff = course.Staff
            };
            isNewCourse = false;
            showEditForm = true;
        }
    }

    private async Task SaveCourse()
    {
        try
        {
            if (isNewCourse)
            {
                await CourseDAO.CreateAsync(courseToEdit);
                Console.WriteLine($"Course '{courseToEdit.CourseName}' created with ID: {courseToEdit.CourseId}");
            }
            else
            {
                await CourseDAO.UpdateAsync(courseToEdit);
                Console.WriteLine($"Course '{courseToEdit.CourseName}' updated.");
            }

            courses = await CourseDAO.GetAllAsync();
            FilterAndSortCourses(); // Re-apply all logic after save
            showEditForm = false;
            GoToPage(1);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving course: {ex.Message}");
            // Implement user-friendly error message display here
        }
    }

    private void CancelEdit()
    {
        courseToEdit = new DUPSS.Object.Course
        {
            CourseId = "",
            CourseName = "",
            CourseType = "",
            TopicId = "",
            StaffId = ""
        };
        showEditForm = false;
    }

    private async Task DeleteCourse(string courseId)
    {
        var courseToDelete = courses?.FirstOrDefault(c => c.CourseId == courseId);
        if (courseToDelete == null)
        {
            Console.WriteLine($"Course with ID {courseId} not found for deletion.");
            return;
        }

        bool confirmed = await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to delete course '{courseToDelete.CourseName}' (ID: {courseId})?");
        if (confirmed)
        {
            try
            {
                var success = await CourseDAO.DeleteAsync(courseId);
                if (success)
                {
                    Console.WriteLine($"Course '{courseToDelete.CourseName}' (ID: {courseId}) deleted successfully.");
                    courses = await CourseDAO.GetAllAsync();
                    FilterAndSortCourses(); // Re-apply all logic after delete
                    GoToPage(1);
                }
                else
                {
                    Console.WriteLine($"Failed to delete course '{courseToDelete.CourseName}'.");
                }
            }
            catch (Exception ex)
                {
                    Console.WriteLine($"Error deleting course: {ex.Message}");
                }
            }
        }
    }
